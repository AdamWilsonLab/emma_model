---
title: "EMMA Prototype"
description: Modeling vegetation postfire recovery data
editor_options: 
  chunk_output_type: console
output:
  html_document:
    toc: true
    toc_depth: 2
---


Model last updated at `r now()`.

```{r, echo=F, message=F,include=F, results="hide"}
library(targets)
library(tidyverse)
library(doParallel)
library(raster)
library(lubridate)
library(sf)
library(plotly)
library(leaflet)

# load data saved in the pipeline
tar_load(c(envdata, stan_data, model_results, spatial_outputs,model_prediction)) 
```

# Model Overview

We estimate the age of a site by calculating the years since the last fire. We then fit a curve to model the recovery of vegetation (measured using NDVI) as a function of it's age. An additional level models the parameters of the negative exponential curve as a function of environmental variables. This means that sites with similar environmental conditions should have similar recovery curves.


## Workflow

This repository was developed using the Targets framework.

```{r, echo=F, eval=T, message=F, include=T, results="asis"}
#tfile=paste0(tempfile(),".html")
targets::tar_visnetwork() #%>% 
#  htmlwidgets::saveWidget(file = tfile)
#webshot::install_phantomjs()
#webshot::webshot(tfile, "network.png")
#![targets_network](network.png)

```


## Results

### Environmental Controls on Ecosystem Recovery

These parameters represent the relationship of the following environmental variables to the recovery trajectory.

```{r p1, echo=F, eval=T, warning=F, message=FALSE}
betas=model_results %>% 
  filter(type=="beta")


p1<-ggplot(betas,aes(y=xname, xmin=q5,x=median,xmax=q95))+
  geom_pointrange(fill="grey")+
  facet_wrap(~parameter,nrow=1)+
  geom_vline(xintercept=0,col="grey")+
  xlab("Beta (regression coefficient +/- 95% CI)")+
  ylab("Environmental Variable") 
ggplotly(p1)

```


## Recovery Trajectories

The plot below illustrates some example recovery trajectories. It currently just shows the top 20 cells with the most observations.

```{r plot, echo=F, eval=T, message=FALSE,fig.height=12}
cells_with_long_records<-
  model_prediction %>% 
  group_by(cellID) %>% 
  summarize(n=n()) %>% 
  arrange(desc(n)) %>% 
  slice(1:20) # top 20 cells with the most observations

model_prediction %>% 
  filter(cellID%in%cells_with_long_records$cellID) %>% 
  ggplot(aes(x=age)) +
 geom_line(aes(y=median),colour="blue") +
  geom_line(aes(y=y_obs),colour="black",lwd=0.5,alpha=0.3) +
  geom_ribbon(aes(ymin=q5,ymax=q95),alpha=0.5)+
  facet_wrap(~cellID) +
  labs(x="time since fire (years)",y="NDVI") +
  theme_bw()
```

## Spatial Predictions

Maps of spatial parameters in the model.  

```{r compare_data2, echo=F, eval=T, warning=F, message=FALSE}
rast=projectRaster(spatial_outputs,crs = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0 +lon_0=0 +x_0=0 +y_0=0 +k=1 +units=m +nadgrids=@null +wktext +no_defs +type=crs")

leaflet() %>% setView(lng = 18.577, lat = -33.998707, zoom = 10) %>% 
  addProviderTiles(providers$Esri.WorldImagery) %>% 
  addRasterImage(rast[[1]],group=names(rast)[1]) %>% #, color = ~pal(values(rast)[,1]) 
  addRasterImage(rast[[2]],group=names(rast)[2]) %>% 
  addRasterImage(rast[[3]],group=names(rast)[3]) %>% 
  addRasterImage(rast[[4]],group=names(rast)[4]) %>% 
  addLayersControl(
    baseGroups = names(rast),
    options = layersControlOptions(collapsed = FALSE)) #%>% 
#  addLegend("bottomright", pal = pal, values = ~,
#    title = "Est. GDP (2010)",
#    labFormat = labelFormat(prefix = "$"),
#    opacity = 1
#  )
```
